# 20251029

## Node.jsによるWebアプリケーション作成入門 を読む
https://zenn.dev/wkb/books/node-tutorial  

### 基礎的なToDoアプリケーションを作成しよう
- https://zenn.dev/wkb/books/node-tutorial/viewer/todo_01

### Node.jsでHTTPサーバを構築しよう
- https://zenn.dev/wkb/books/node-tutorial/viewer/todo_02
- common.js + httpモジュール版
- ポート番号3000使用

### ToDoアプリをExpressで作成しよう
- https://zenn.dev/wkb/books/node-tutorial/viewer/todo_03
- テンプレートアプリ

#### ルーティング / レンダリング
- app.js > const app = express(); / app.use('/', require('./routes'));
    > app.use('/', require('./routes')); でルートパス　('/') に対するアクセスを ./routes/index で処理させていることがわかります。  
- routes/index.js > var router = express.Router(); / router.get
    > router.get から想像できるように、  
    > Expressでは、const router = express.Router(); と router.get もしくは router.post でルーティングを行います。  
- レンダリング：`router.get` に res.render('index', { title: 'ToDo App' }); を記述
    > index.jsの6行目、res.render('index', { title: 'Express' });で分かるとおり、res.render()で行なっており、第一引数と合致する.ejsファイルに紐づいています。  
    > また、第二引数には.ejsファイルに渡したい値をオブジェクトで渡します。  

#### POSTリクエストのルーティング
- index.ejs > <form action="/" method="post">
    > <form action="/" method="post"> では、action属性でaction="/"とすることで"/"にリクエストを送信するうよう指定しています。  
    > また、method="post"とすることでPOSTリクエストで送信するようしていしています。  
    > 先述のとおり、ルートパス ("/") へのリクエストは routes/index.jsで行なっていますが、POSTリクエストのルーティングは定義されていないため、自力で行う必要があります。  
- index.js > router.post
- レンダリング：`router.post` に res.render('index', { title: 'ToDo App' }); を記述  
- レンダリングを行わずルートパスにGETリクエストする場合：`res.redirect('/');`

### データベースを学ぼう
- https://zenn.dev/wkb/books/node-tutorial/viewer/todo_04  
- PostgreSQLのDB作成、接続方法を別途確認する  

## 調べもの
### ポート番号は3000と8080どっちを使えばいいの？
- https://zenn.dev/harper/articles/b49574a64991bd
    > ポート8080（HTTPの代替）  
    > 用途: 開発やテスト環境、またはプロキシサーバーでよく使用されます。  
    > 特徴: HTTPと同じく非暗号化の通信を行いますが、通常はポート80が使用される環境で代替として用いられます。  
    >   
    > ポート3000（開発用）  
    > 用途: Node.jsやReactなどの開発サーバーがデフォルトで使用するポートです。  
    > 特徴: 主にローカル開発環境で利用されるポートで、プロダクション環境ではあまり使われません。  

### index.js or main.js
- Common.jsの場合： const routes = require('./routes'); に記述したディレクトリ下のindex.jsを暗黙的に読み込む  
- ESMの場合：`import routes from './routes';` はエラー、`import routes from './routes/index.js';` とする  
- 慣習的にルーティングを記述するファイルはindex.jsとすることが多い
- main.jsのような命名はサーバーを起動するエントリーポイントとして使うことが多い  

### POST時にリダイレクトしない方法
- JSONを返してクライアント側でFetch  
    
    JavaScript
        // サーバー側
        app.post('/api/todos', (req, res) => {
        todos.push(req.body.todo);
        res.json({ success: true, todos });
        });
        

        
    JavaScript
        // フロント側
        document.querySelector('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const todo = e.target.todo.value;

        const res = await fetch('/api/todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ todo })
        });

        const data = await res.json();
        renderTodos(data.todos); // 画面を更新する関数
        });
        

- fetch はクライアント側でページ遷移せずにAPIリクエストを送るために使う
- APIがREST API形式の場合JSONベースでのやりとりになるのでクライアント側でfetchで扱いやすい

### postgreSQL + Renderデプロイ
- RenderではpostgreSQL作成時に接続情報を環境変数で扱う
- ローカル環境でも同じ変数を.envファイルに宣言しておくとコード側は変更せずにデプロイできる

#### 開発時
- postgreSQLインストール、GUIでDB作成
- .envファイルに環境変数を設定 -> npm install dotenv で読み込み、.gitignoreする
- node.jsコード側では接続時に環境変数を使用

#### デプロイ時
- Render登録 ※バックエンドとDBに時間・日数制限があるためリリース時は有料版を検討する
- RenderでPostgreSQL作成
- GitHubリポジトリをRenderにデプロイ

### Node.js + postgreSQL 接続
- npm install pg
- .envファイル作成 → .gitignoreファイルに.envを追加しておく
    

    PGHOST=localhost
    PGUSER=postgres
    PGDATABASE=myappdb
    PGPASSWORD=mypassword
    PGPORT=5432
    

- npm install dotenv
- db.js 作成
    

    import 'dotenv/config';
    import pkg from 'pg';
    const { Pool } = pkg;

    const pool = new Pool({
        user: process.env.PGUSER,
        host: process.env.PGHOST,
        database: process.env.PGDATABASE,
        password: process.env.PGPASSWORD,
        port: process.env.PGPORT,
    });

    export default pool;
    

- pgはCommonJSのモジュール
- CommonJSの場合は`const { Pool } = require('pg');` / const pool = new Pool({...})
- ESMでのimport時は`import pkg from 'pg';` / const { pool } = pkg; / const pool = new Pool({...}) の形で扱う
- CommonJS -> EMS 参考：https://zenn.dev/yodaka/articles/596f441acf1cf3