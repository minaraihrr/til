# 20251118
## Express + PostgreSQL (pg：node-postgres)
- プレースホルダーに値を渡してクエリを発行したい  
    - `pool.query(sql, values)`  
- 連番のカラムを作成したい  
    -  `SELECT generate_series(1, 12) AS month;`  
    - 1~12の連番を持つ12行が作成される  
- 連番のカラムを持つ行の集合をテーブルとして扱う  
    - `SELECT g.month FROM generate_series(1, 12) AS g(month);`  
    - `g`はテーブルエイリアス、`(month)`はカラムエイリアスとして扱える  
- 日付を計算（加算、減算）する  
    - `SELECT '2025-11-18'::date + make_interval(days => 1) AS tomorrow;`  
    - 結果は `2025-11-19 00:00:00`  
    - make_intervalは期間を指定する。psqlはDATEADDなどの関数はない  
    - 月や年の計算時は `make_interval(month => 1)`、`make_interval(years => 1)` を使用  
    - ::date はデータ型の指定
- 日付カラムを年数分作成して一致するデータを取得するクエリ
    ※データがない場合に日付だけ表示する対応
    ```JavaScript
    const result = await pool.query(`
        WITH target_dates AS (
            SELECT ($1::date - make_interval(years => g.i))::date AS entry_date
            FROM generate_series(0, $2 - 1) AS g(i) 
        )
        SELECT
            t.entry_date,
            d.id,
            d.content
        FROM target_dates t
        LEFT JOIN diaries d
            ON t.entry_date = d.entry_date
        ORDER BY t.entry_date DESC
        `, [date, year]);
    ```